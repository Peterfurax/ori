<!DOCTYPE html>

<html>
<head>
  <title>app.service.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="app.component.html">
                  app.component.ts
                </a>
              
                
                <a class="source" href="app.module.html">
                  app.module.ts
                </a>
              
                
                <a class="source" href="app.service.html">
                  app.service.ts
                </a>
              
                
                <a class="source" href="data.provider.html">
                  data.provider.ts
                </a>
              
                
                <a class="source" href="main.dev.html">
                  main.dev.ts
                </a>
              
                
                <a class="source" href="main.prod.html">
                  main.prod.ts
                </a>
              
                
                <a class="source" href="main.html">
                  main.ts
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>app.service.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { Injectable } from <span class="hljs-string">"@angular/core"</span>
<span class="hljs-keyword">import</span> {
  SpinnerDialog,
  BackgroundMode,
  Vibration,
  Transfer,
  VideoPlayer,
  LocalNotifications,
  Toast,
  AppVersion,
  MediaCapture,
  Camera,
  VideoEditor,
  File,
  SQLite
} from <span class="hljs-string">"ionic-native"</span>
<span class="hljs-keyword">import</span> * as moment from <span class="hljs-string">"moment"</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">"moment/src/locale/fr"</span>
@Injectable()

<span class="hljs-comment">/**
 *  class AppService
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppService {
  <span class="hljs-keyword">constructor</span>() { }

  <span class="hljs-keyword">private</span> appName: Promise&lt;<span class="hljs-built_in">string</span>&gt;;
  <span class="hljs-keyword">private</span> appPackageName: Promise&lt;<span class="hljs-built_in">string</span>&gt;;
  <span class="hljs-keyword">private</span> appVersionNumber: Promise&lt;<span class="hljs-built_in">string</span>&gt;;
  <span class="hljs-keyword">private</span> appAllInfo: {
    Names: <span class="hljs-built_in">string</span>,
    PackageName: <span class="hljs-built_in">string</span>,
    VersionNumber: <span class="hljs-built_in">string</span>
  } = {
    Names: <span class="hljs-string">""</span>,
    PackageName: <span class="hljs-string">""</span>,
    VersionNumber: <span class="hljs-string">""</span>
  };

  <span class="hljs-comment">/**
   * @name appVersionAll
   * @desc Retrieve app info from AppVersion ionic-native
   * @type PromiseAll
   * @return type:Array [TubeR, com.lesechos.tuber, "0.0.1"] == [AppName, PackageName, VersionNumber]
   */</span>
  appVersionAll() {
    <span class="hljs-keyword">this</span>.appName = AppVersion.getAppName()
    <span class="hljs-keyword">this</span>.appPackageName = AppVersion.getPackageName()
    <span class="hljs-keyword">this</span>.appVersionNumber = AppVersion.getVersionNumber()
    Promise.all([<span class="hljs-keyword">this</span>.appName, <span class="hljs-keyword">this</span>.appPackageName, <span class="hljs-keyword">this</span>.appVersionNumber]).then(
      values =&gt; {
        <span class="hljs-keyword">this</span>.appAllInfo.Names = values[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">this</span>.appAllInfo.PackageName = values[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">this</span>.appAllInfo.VersionNumber = values[<span class="hljs-number">2</span>]
      },
      err =&gt; { })
  }

  <span class="hljs-comment">/**
   * [notificationMaker description]
   * @desc
   */</span>
  notificationMaker() {
    <span class="hljs-keyword">this</span>.notification()
    <span class="hljs-keyword">this</span>.vibrate([<span class="hljs-number">500</span>, <span class="hljs-number">500</span>, <span class="hljs-number">500</span>])
  }

  <span class="hljs-comment">/**
   * [vibrate description]
   * @param {any} param [description]
   * @desc
   */</span>
  vibrate(param: <span class="hljs-built_in">any</span>) {
    Vibration.vibrate(param)
  }

  <span class="hljs-comment">/**
   * [notification description]
   */</span>
  notification() {
    LocalNotifications.schedule({
      title: <span class="hljs-string">"Application Video"</span>,
      text: <span class="hljs-string">"message"</span>,
      sound: <span class="hljs-string">"file://assets/sound/notification_ok.mp3"</span>
    })
  }

}

<span class="hljs-comment">/**
 *  class VideoService
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> VideoService {
  <span class="hljs-keyword">constructor</span>() {
    moment.locale(<span class="hljs-string">"fr"</span>);
  }
  <span class="hljs-keyword">public</span> database: SQLite;
  <span class="hljs-keyword">public</span> people: <span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">Object</span>&gt;;
  <span class="hljs-keyword">public</span> videoArr: <span class="hljs-built_in">any</span>;
  <span class="hljs-keyword">public</span> videoAllInfo: {
    dateImport: <span class="hljs-built_in">number</span>,
    datePrise: <span class="hljs-built_in">string</span>,
    uri: <span class="hljs-built_in">string</span>,
    uriThumb: <span class="hljs-built_in">string</span>,
    infoVideo: {
      bitrate: <span class="hljs-built_in">number</span>,
      duration: <span class="hljs-built_in">number</span>,
      height: <span class="hljs-built_in">number</span>,
      orientation: <span class="hljs-built_in">string</span>,
      size: <span class="hljs-built_in">number</span>,
      width: <span class="hljs-built_in">number</span>
    }
  } = {
    dateImport: <span class="hljs-number">0</span>,
    datePrise: <span class="hljs-string">""</span>,
    uri: <span class="hljs-string">""</span>,
    uriThumb: <span class="hljs-string">""</span>,
    infoVideo: {
      bitrate: <span class="hljs-number">0</span>,
      duration: <span class="hljs-number">0</span>,
      height: <span class="hljs-number">0</span>,
      orientation: <span class="hljs-string">""</span>,
      size: <span class="hljs-number">0</span>,
      width: <span class="hljs-number">0</span>
    }
  }

  <span class="hljs-comment">/**
   * [notificationMaker description]
   * @desc
   */</span>
  notificationMaker(message) {
    <span class="hljs-keyword">this</span>.notification(message)
    <span class="hljs-keyword">this</span>.vibrate([<span class="hljs-number">500</span>, <span class="hljs-number">500</span>, <span class="hljs-number">500</span>])
  }

  <span class="hljs-comment">/**
   * [notification description]
   * @desc
   */</span>
  notification(message: <span class="hljs-built_in">any</span>) {
    LocalNotifications.schedule({
      title: <span class="hljs-string">"Application Video"</span>,
      text: message,
      sound: <span class="hljs-string">"file://assets/sound/notification_ok.mp3"</span>
    })
  }

  <span class="hljs-comment">/**
   * [vibrate description]
   * @desc
   * @param {any} param [description]
   */</span>
  vibrate(param: <span class="hljs-built_in">any</span>) {
    Vibration.vibrate(param)
  }

  <span class="hljs-comment">/**
   * [toast description]
   * @desc
   * @param {any} message [description]
   */</span>
  toast(message: <span class="hljs-built_in">any</span>) {
    Toast.show(message, <span class="hljs-string">"5000"</span>, <span class="hljs-string">"center"</span>).subscribe(
      toast =&gt; <span class="hljs-built_in">console</span>.log(toast)
    )
  }

  <span class="hljs-comment">/**
   * [playVideo description]
   * @desc
   * @param {[type]} uri [description]
   */</span>
  playVideo(uri) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>NOT COOL MUST FIX URI :/</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    uri = <span class="hljs-string">"file:/"</span> + uri
    VideoPlayer.play(uri).then(
      () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"video completed"</span>)).catch(
      err =&gt; <span class="hljs-built_in">console</span>.log(err)
      )
  }

  <span class="hljs-comment">/**
   * [CAPTURE VIDEO FROM CAMERA DEVICE]
   * @name captureVideo()
   * @function Load native camera device { MediaCapture } from "ionic-native"
   * @type Promise
   * @param null
   * @return :
   * [
   *   fullPath: "file:/storage/emulated/0/DCIM/Camera/VID_20161119_075425.mp4",
   *   lastModified: null,
   *   lastModifiedDate:1479538465000,
   *   localURL: "cdvfile://localhost/sdcard/DCIM/Camera/VID_20161119_075425.mp4",
   *   name: "VID_20161119_075425.mp4",
   *   size:561702,
   *   start:0,
   *   type: "video/mp4"
   * ]
   */</span>
  captureVideo() {
    MediaCapture.captureVideo()
      .then(
      data =&gt; <span class="hljs-keyword">this</span>.stockCaptureVideo(data),
      err =&gt; <span class="hljs-built_in">console</span>.error(err)
      );
  }

  <span class="hljs-comment">/**
   * [captureImage description]
   * @desc
   */</span>
  captureImage() {
    MediaCapture.captureImage()
      .then(
      data =&gt; <span class="hljs-built_in">console</span>.log(data),
      err =&gt; <span class="hljs-built_in">console</span>.error(err)
      );
  }

  <span class="hljs-comment">/**
   * [uriToDate description]
   * @desc
   * @param {string} uriParse [description]
   * @return {Promise}     [description]
   */</span>
  uriToDate(uriParse: <span class="hljs-built_in">string</span>): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      <span class="hljs-keyword">let</span> date = moment(uriParse, <span class="hljs-string">"YYYYMMDD_HHmmss"</span>).toISOString()
      <span class="hljs-keyword">if</span> (!moment(date).isValid()) { reject(<span class="hljs-string">"error parsing uriToDate"</span>) }
      resolve(date)
    })
  }

  <span class="hljs-comment">/**
   * [parseUriDate description]
   * @desc
   * @param {string} dateExtract [description]
   * @return {Promise}     [description]
   */</span>
  parseUriDate(dateExtract: <span class="hljs-built_in">string</span>): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      <span class="hljs-keyword">this</span>.uriToDate(dateExtract)
        .then(
        data =&gt; resolve(data),
        err =&gt; reject(err)
        )
    })
  }

  <span class="hljs-comment">/**
   * [parseUri description]
   * @desc
   * @param {string} uri [description]
   */</span>
  parseUri(uri: <span class="hljs-built_in">string</span>) {
    <span class="hljs-keyword">let</span> uriFile = (<span class="hljs-regexp">/[^/]*$/g</span>).exec(uri)
    <span class="hljs-keyword">let</span> dateExtract = (<span class="hljs-regexp">/[^.]*/g</span>).exec(uriFile[<span class="hljs-number">0</span>])
    <span class="hljs-keyword">return</span> dateExtract[<span class="hljs-number">0</span>]
  }

  <span class="hljs-comment">/**
   * [convertUriToDate description]
   * @desc
   * @param {string} uri [description]
   */</span>
  convertUriToDate(uri: <span class="hljs-built_in">string</span>): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      <span class="hljs-keyword">this</span>.parseUriDate(<span class="hljs-keyword">this</span>.parseUri(uri))
        .then(
        data =&gt; resolve(data),
        err =&gt; reject(err)
        )
    })
  }

  <span class="hljs-comment">/**
   * [stockCaptureVideo description]
   * @desc
   * @param  {[type]}  uri [file:/storage/emulated/0/DCIM/Camera/VID_20161119_075425.mp4]
   * @return {Promise}     [description]
   */</span>
  stockCaptureVideo(uri): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      Promise.all([<span class="hljs-keyword">this</span>.getVideoMeta(uri), <span class="hljs-keyword">this</span>.getVideoThumb(uri), <span class="hljs-keyword">this</span>.convertUriToDate(uri)])
        .then(
        data =&gt; {
          <span class="hljs-keyword">this</span>.videoAllInfo.infoVideo = &lt;<span class="hljs-built_in">any</span>&gt;data[<span class="hljs-number">0</span>]
          <span class="hljs-keyword">this</span>.videoAllInfo.uriThumb = data[<span class="hljs-number">1</span>]
          <span class="hljs-keyword">this</span>.videoAllInfo.datePrise = data[<span class="hljs-number">2</span>]
          <span class="hljs-keyword">this</span>.videoAllInfo.dateImport = <span class="hljs-built_in">Date</span>.now()
          <span class="hljs-keyword">this</span>.videoAllInfo.uri = uri
          resolve(<span class="hljs-keyword">this</span>.videoAllInfo)
        },
        err =&gt; reject(err)
        )
    })
  }

  <span class="hljs-comment">/**
   * [getVideoUri description]
   * @desc
   * @return {Promise} [description]
   */</span>
  getVideoUri(): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      Camera.getPicture({
        quality: <span class="hljs-number">50</span>,
        destinationType: Camera.DestinationType.FILE_URI,
        sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
        mediaType: <span class="hljs-number">1</span>
      })
        .then(
        data =&gt; resolve(data),
        err =&gt; reject(err)
        )
    })
  }

  <span class="hljs-comment">/**
   * [getVideoMeta description]
   * @desc
   * @param  {string}  uri [storage/emulated/0/DCIM/Camera/VID_20161119_075425.mp4]
   * @return {Promise}     [description]
   */</span>
  getVideoMeta(uri): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      uri = <span class="hljs-string">"file:/"</span> + uri; <span class="hljs-comment">// NOT COOL MUST FIX URI :/</span>
      VideoEditor.getVideoInfo({ fileUri: uri })
        .then(
        data =&gt; {
          <span class="hljs-keyword">if</span> (data.orientation === <span class="hljs-string">"portrait"</span>) {
            <span class="hljs-keyword">this</span>.toast(<span class="hljs-string">"Rejet : Format portrait détecté"</span>)
            reject(<span class="hljs-string">"portrait"</span>)
          }
          resolve(data)
        },
        err =&gt; reject(err)
        )
    })
  }

  <span class="hljs-comment">/**
   * [getVideoThumb description]
   * @desc
   * @param  {string}  uri [storage/emulated/0/DCIM/Camera/VID_20161119_075425.mp4]
   * @return {Promise}     [/storage/emulated/0/Android/data/com.ionicframework.tuber560001/files/files/videos/output-name.jpg]
   */</span>
  date: <span class="hljs-built_in">any</span>;
  getVideoThumb(uri: <span class="hljs-built_in">string</span>): Promise&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">this</span>.date = <span class="hljs-built_in">Date</span>.now()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Promise((resolve, reject) =&gt; {
      uri = <span class="hljs-string">"file:/"</span> + uri <span class="hljs-comment">// NOT COOL MUST FIX URI :/</span>
      VideoEditor.createThumbnail({
        fileUri: uri, <span class="hljs-comment">// the path to the video on the device</span>
        outputFileName: <span class="hljs-keyword">this</span>.date, <span class="hljs-comment">// the file name for the JPEG image</span>
        atTime: <span class="hljs-number">10</span>, <span class="hljs-comment">// optional, location in the video to create the thumbnail (in seconds)</span>
        width: <span class="hljs-number">320</span>, <span class="hljs-comment">// optional, width of the thumbnail</span>
        height: <span class="hljs-number">480</span>, <span class="hljs-comment">// optional, height of the thumbnail</span>
        quality: <span class="hljs-number">100</span> <span class="hljs-comment">// optional, quality of the thumbnail (between 1 and 100)</span>
      })
        .then(
        data =&gt; resolve(data),
        err =&gt; reject(err)
        )
    })
  }


  <span class="hljs-comment">/**
   * [UploadInitService description]
   * @desc
   */</span>
  uploadInitService() {
    SpinnerDialog.show(<span class="hljs-keyword">this</span>.progress)
    BackgroundMode.enable()
  }

  <span class="hljs-comment">/**
   * [uploadEndService description]
   * @desc
   * @param {string} message [description]
   */</span>
  uploadEndService(message: <span class="hljs-built_in">string</span>) {
    SpinnerDialog.hide()
    BackgroundMode.disable()
    <span class="hljs-keyword">this</span>.notificationMaker(message)
    <span class="hljs-keyword">this</span>.toast(message)
  }

  <span class="hljs-comment">/**
   * [upload description]
   * @desc
   * @param {[type]} item [description]
   */</span>
  progress: <span class="hljs-built_in">any</span>
  upload(item) {
    <span class="hljs-keyword">this</span>.witreJsonMetaToUpload()
    <span class="hljs-keyword">this</span>.uploadInitService()
    <span class="hljs-keyword">const</span> fileTransfer = <span class="hljs-keyword">new</span> Transfer()
    <span class="hljs-keyword">let</span> optionsVideo = {
      mimeType: <span class="hljs-string">"video/mp4"</span>,
      timeout: <span class="hljs-number">3000</span>,
      fileName: <span class="hljs-built_in">Date</span>.now() + <span class="hljs-string">".mp4"</span>
    }

    fileTransfer.onProgress(
      progressEvent =&gt; {
        <span class="hljs-keyword">if</span> (progressEvent.lengthComputable) {
          <span class="hljs-keyword">let</span> perc = <span class="hljs-built_in">Math</span>.floor(progressEvent.loaded / progressEvent.total * <span class="hljs-number">100</span>)
          <span class="hljs-keyword">this</span>.progress = perc
          <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.progress)
        }
      }
    )

    fileTransfer.upload(item.uri, <span class="hljs-string">"http://192.168.0.12:8000"</span>, optionsVideo)
      .then(
      data =&gt; <span class="hljs-keyword">this</span>.uploadEndService(<span class="hljs-built_in">JSON</span>.stringify(data)),
      err =&gt; <span class="hljs-keyword">this</span>.uploadEndService(<span class="hljs-built_in">JSON</span>.stringify(err))
      )
  }

  witreJsonMetaToUpload() {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>let cordova: any;
console.log(cordova.file)
const fs:string = cordova.file.dataDirectory;
File.checkDir(this.fs, ‘assets’).then(_ =&gt; console.log(‘yay’)).catch(err =&gt; console.log(‘boooh’));
File.createFile(path, fileName, replace)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
  <span class="hljs-comment">/**
   * [BgEnable description]
   * @desc
   */</span>
  BgEnable() {
    BackgroundMode.enable()
  }





}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
